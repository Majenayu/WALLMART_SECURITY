<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Watchman Portal</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;color:#333}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .auth-container{max-width:400px;margin:20vh auto;background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.2);padding:40px 30px;text-align:center}
        .auth-title{color:#1e3c72;font-size:2.2em;margin-bottom:20px;font-weight:bold}
        .security-icon{font-size:4em;margin-bottom:20px;color:#2a5298}
        .form-group{margin-bottom:20px;text-align:left}
        .form-label{display:block;margin-bottom:8px;color:#555;font-weight:600}
        .form-input{width:100%;padding:15px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px;transition:border-color 0.3s}
        .form-input:focus{outline:none;border-color:#2a5298}
        .form-select{width:100%;padding:15px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px;background:white}
        .auth-btn{background:linear-gradient(45deg,#1e3c72,#2a5298);color:white;padding:15px 30px;border:none;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;width:100%;margin:10px 0;transition:transform 0.2s}
        .auth-btn:hover{transform:translateY(-2px)}
        .auth-btn:disabled{opacity:0.6;cursor:not-allowed}
        .main-app{display:none;min-height:100vh}
        .header{background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .user-info{display:flex;align-items:center;gap:15px}
        .user-avatar{width:50px;height:50px;background:linear-gradient(45deg,#1e3c72,#2a5298);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5em;font-weight:bold}
        .user-details h2{color:#1e3c72;margin-bottom:5px}
        .user-details p{color:#666;font-size:0.9em}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .stat-number{font-size:2.5em;font-weight:bold;color:#2a5298;margin-bottom:10px}
        .stat-label{color:#666;font-size:0.9em;text-transform:uppercase;letter-spacing:1px}
        .orders-section{background:white;border-radius:15px;padding:30px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .section-title{font-size:1.8em;color:#1e3c72;margin-bottom:25px;display:flex;align-items:center;gap:10px}
        .orders-grid{display:grid;gap:20px}
        .order-card{background:#f8f9fa;border-radius:12px;padding:20px;border-left:5px solid #ffc107;position:relative;transition:all 0.3s ease}
        .order-card.assigned{border-left-color:#28a745}
        .order-card.expired{border-left-color:#dc3545;opacity:0.7}
        .order-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
        .customer-name{font-size:1.3em;font-weight:bold;color:#1e3c72;margin-bottom:5px}
        .order-meta{display:flex;gap:15px;color:#666;font-size:0.85em;margin-bottom:15px}
        .order-items{background:white;border-radius:8px;padding:15px;margin:15px 0}
        .item-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #eee}
        .item-row:last-child{border-bottom:none}
        .item-name{font-weight:600}
        .item-qty{color:#666;font-size:0.9em}
        .item-price{color:#28a745;font-weight:bold}
        .order-total{background:linear-gradient(45deg,#1e3c72,#2a5298);color:white;padding:15px;border-radius:8px;text-align:center;font-size:1.2em;font-weight:bold;margin:15px 0}
        .timer{position:absolute;top:15px;right:15px;background:#ffc107;color:#000;padding:5px 10px;border-radius:20px;font-size:0.8em;font-weight:bold}
        .timer.warning{background:#ff6b35}
        .timer.expired{background:#dc3545;color:white}
        .action-buttons{display:flex;gap:10px;margin-top:15px}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s}
        .btn-confirm{background:#28a745;color:white}
        .btn-confirm:hover{background:#218838}
        .btn-confirm:disabled{background:#6c757d;cursor:not-allowed}
        .empty-state{text-align:center;padding:60px 20px;color:#666}
        .empty-icon{font-size:4em;margin-bottom:20px;opacity:0.5}
        .loading{text-align:center;padding:40px;color:#666}
        .msg{padding:15px;border-radius:10px;margin:15px 0;text-align:center;font-weight:600}
        .success{background:#d4edda;color:#155724}
        .error{background:#f8d7da;color:#721c24}
        .warning{background:#fff3cd;color:#856404}
        .logout-btn{background:#dc3545;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600}
        .logout-btn:hover{background:#c82333}
        .hidden{display:none!important}
        @media (max-width:768px){
            .container{padding:10px}
            .header{flex-direction:column;gap:15px;text-align:center}
            .stats{grid-template-columns:1fr 1fr}
            .orders-section{padding:20px 15px}
            .order-header{flex-direction:column;gap:10px}
            .action-buttons{flex-direction:column}
            .order-meta{flex-direction:column;gap:5px}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="authSection" class="auth-container">
            <div class="security-icon">üõ°Ô∏è</div>
            <h2 class="auth-title">Security Portal</h2>
            <div class="form-group">
                <label class="form-label">Watchman Name</label>
                <input type="text" id="watchmanName" class="form-input" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label class="form-label">Security ID</label>
                <select id="securityId" class="form-select">
                    <option value="">Select Security ID</option>
                    <option value="1">Security ID - 1</option>
                    <option value="2">Security ID - 2</option>
                    <option value="3">Security ID - 3</option>
                    <option value="4">Security ID - 4</option>
                    <option value="5">Security ID - 5</option>
                </select>
            </div>
            <button id="loginBtn" class="auth-btn" onclick="login()">Sign In</button>
            <div id="authMsg"></div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="main-app">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">S</div>
                    <div class="user-details">
                        <h2 id="userName">Watchman</h2>
                        <p>Security ID: <span id="userSecurityId">1</span> | Status: <span id="userStatus">Active</span></p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalAssigned">0</div>
                    <div class="stat-label">Total Assigned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalConfirmed">0</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="efficiency">0%</div>
                    <div class="stat-label">Efficiency</div>
                </div>
            </div>

            <div class="orders-section">
                <h3 class="section-title">
                    üéØ Assigned Orders
                    <span style="font-size:0.6em;background:#ffc107;color:#000;padding:5px 10px;border-radius:15px;margin-left:auto">Live Updates</span>
                </h3>
                
                <div id="loadingOrders" class="loading">
                    <div style="font-size:2em;margin-bottom:10px">‚è≥</div>
                    Loading orders...
                </div>
                
                <div id="ordersContainer" class="orders-grid hidden"></div>
                
                <div id="emptyOrders" class="empty-state hidden">
                    <div class="empty-icon">üì¶</div>
                    <h3>No orders assigned</h3>
                    <p>New orders will appear here automatically</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentWatchman = null;
        let assignedOrders = [];
        let stats = { totalAssigned: 0, totalConfirmed: 0, totalPending: 0, efficiency: 0 };
        let updateInterval = null;
        const API_BASE = window.location.origin;

        // Authentication
        function login() {
            const name = document.getElementById('watchmanName').value.trim();
            const securityId = document.getElementById('securityId').value;
            
            if (!name || !securityId) {
                showAuthMsg('Please fill in all fields', 'error');
                return;
            }
            
            if (name.length < 2) {
                showAuthMsg('Name must be at least 2 characters', 'error');
                return;
            }
            
            currentWatchman = {
                name: name,
                securityId: securityId,
                loginTime: new Date(),
                status: 'active'
            };
            
            // Save to localStorage for session persistence
            localStorage.setItem('currentWatchman', JSON.stringify(currentWatchman));
            
            showMainApp();
            showAuthMsg('Login successful!', 'success');
        }

        function logout() {
            currentWatchman = null;
            assignedOrders = [];
            localStorage.removeItem('currentWatchman');
            
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear form
            document.getElementById('watchmanName').value = '';
            document.getElementById('securityId').value = '';
            clearAuthMsg();
        }

        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI with watchman info
            document.getElementById('userName').textContent = currentWatchman.name;
            document.getElementById('userSecurityId').textContent = currentWatchman.securityId;
            document.getElementById('userAvatar').textContent = currentWatchman.name.charAt(0).toUpperCase();
            
            // Start fetching orders
            fetchAssignedOrders();
            loadStats();
            
            // Set up auto-refresh every 10 seconds
            updateInterval = setInterval(() => {
                fetchAssignedOrders();
                updateTimers();
            }, 10000);
        }

        // Fetch orders assigned to this watchman
        async function fetchAssignedOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/security/orders/${currentWatchman.securityId}`);
                const result = await response.json();
                
                if (result.success) {
                    assignedOrders = result.orders || [];
                    displayOrders();
                    updateStats();
                } else {
                    console.error('Failed to fetch orders:', result.error);
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                showMsg('Failed to load orders. Retrying...', 'error');
            }
        }

        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            const loading = document.getElementById('loadingOrders');
            const empty = document.getElementById('emptyOrders');
            
            loading.classList.add('hidden');
            
            if (assignedOrders.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = assignedOrders.map(order => {
                const assignedTime = new Date(order.assignedAt);
                const timeElapsed = Math.floor((Date.now() - assignedTime.getTime()) / 1000);
                const remainingTime = Math.max(0, 300 - timeElapsed); // 5 minutes = 300 seconds
                
                let timerClass = '';
                let timerText = '';
                let cardClass = 'order-card';
                
                if (remainingTime === 0) {
                    timerClass = 'expired';
                    timerText = 'EXPIRED';
                    cardClass += ' expired';
                } else if (remainingTime <= 60) {
                    timerClass = 'warning';
                    timerText = `${remainingTime}s`;
                } else {
                    timerClass = '';
                    timerText = `${Math.floor(remainingTime / 60)}:${String(remainingTime % 60).padStart(2, '0')}`;
                }
                
                if (order.status === 'assigned') {
                    cardClass += ' assigned';
                }
                
                return `
                    <div class="${cardClass}" data-order-id="${order.orderId}">
                        <div class="timer ${timerClass}">${timerText}</div>
                        <div class="order-header">
                            <div>
                                <div class="customer-name">${order.customer}</div>
                                <div class="order-meta">
                                    <span>üìù ${order.orderId}</span>
                                    <span>üìÖ ${new Date(order.createdAt).toLocaleDateString()}</span>
                                    <span>‚è∞ ${new Date(order.createdAt).toLocaleTimeString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-items">
                            ${order.items.map(item => `
                                <div class="item-row">
                                    <div>
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-qty">Qty: ${item.quantity}</div>
                                    </div>
                                    <div class="item-price">$${item.total.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="order-total">
                            Total Amount: $${order.total.toFixed(2)}
                        </div>
                        
                        <div class="action-buttons">
                            <button 
                                class="btn btn-confirm" 
                                onclick="confirmOrder('${order.orderId}')"
                                ${remainingTime === 0 ? 'disabled' : ''}
                            >
                                ‚úÖ Confirm Verification
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Confirm order verification
        async function confirmOrder(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/security/confirm/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        securityId: currentWatchman.securityId,
                        watchmanName: currentWatchman.name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMsg('Order verified successfully! ‚úÖ', 'success');
                    
                    // Remove the order from UI immediately
                    const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                    if (orderCard) {
                        orderCard.style.transition = 'all 0.5s ease';
                        orderCard.style.transform = 'translateX(100%)';
                        orderCard.style.opacity = '0';
                        
                        setTimeout(() => {
                            fetchAssignedOrders(); // Refresh the list
                        }, 500);
                    }
                    
                    // Update stats
                    stats.totalConfirmed++;
                    updateStatsDisplay();
                } else {
                    showMsg(result.error || 'Failed to confirm order', 'error');
                }
            } catch (error) {
                console.error('Error confirming order:', error);
                showMsg('Failed to confirm order. Please try again.', 'error');
            }
        }

        // Update timers for all orders
        function updateTimers() {
            assignedOrders.forEach(order => {
                const assignedTime = new Date(order.assignedAt);
                const timeElapsed = Math.floor((Date.now() - assignedTime.getTime()) / 1000);
                const remainingTime = Math.max(0, 300 - timeElapsed);
                
                const orderCard = document.querySelector(`[data-order-id="${order.orderId}"]`);
                if (orderCard) {
                    const timer = orderCard.querySelector('.timer');
                    const confirmBtn = orderCard.querySelector('.btn-confirm');
                    
                    if (remainingTime === 0) {
                        timer.className = 'timer expired';
                        timer.textContent = 'EXPIRED';
                        confirmBtn.disabled = true;
                        orderCard.classList.add('expired');
                    } else if (remainingTime <= 60) {
                        timer.className = 'timer warning';
                        timer.textContent = `${remainingTime}s`;
                    } else {
                        timer.className = 'timer';
                        timer.textContent = `${Math.floor(remainingTime / 60)}:${String(remainingTime % 60).padStart(2, '0')}`;
                    }
                }
            });
        }

        // Load and update statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/security/stats/${currentWatchman.securityId}`);
                const result = await response.json();
                
                if (result.success) {
                    stats = result.stats;
                    updateStatsDisplay();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateStats() {
            stats.totalPending = assignedOrders.length;
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('totalAssigned').textContent = stats.totalAssigned || 0;
            document.getElementById('totalConfirmed').textContent = stats.totalConfirmed || 0;
            document.getElementById('totalPending').textContent = stats.totalPending || 0;
            
            const efficiency = stats.totalAssigned > 0 
                ? Math.round((stats.totalConfirmed / stats.totalAssigned) * 100)
                : 0;
            document.getElementById('efficiency').textContent = `${efficiency}%`;
        }

        // Utility functions
        function showAuthMsg(text, type) {
            const msg = document.getElementById('authMsg');
            msg.innerHTML = `<div class="msg ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 4000);
        }

        function clearAuthMsg() {
            document.getElementById('authMsg').innerHTML = '';
        }

        function showMsg(text, type) {
            const msg = document.createElement('div');
            msg.className = `msg ${type}`;
            msg.textContent = text;
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }

        // Session persistence
        window.addEventListener('load', () => {
            const savedWatchman = localStorage.getItem('currentWatchman');
            if (savedWatchman) {
                try {
                    currentWatchman = JSON.parse(savedWatchman);
                    // Check if session is not too old (24 hours)
                    const loginTime = new Date(currentWatchman.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        showMainApp();
                    } else {
                        logout(); // Session expired
                    }
                } catch (e) {
                    logout();
                }
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentWatchman) {
                fetchAssignedOrders(); // Refresh when page becomes visible
            }
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>